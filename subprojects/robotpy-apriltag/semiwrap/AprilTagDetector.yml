extra_includes:
- nanobind/ndarray.h

classes:
  frc::AprilTagDetector:
    methods:
      AprilTagDetector:
      SetConfig:
      GetConfig:
      SetQuadThresholdParameters:
      GetQuadThresholdParameters:
      AddFamily:
      RemoveFamily:
      ClearFamilies:
      Detect:
        overloads:
          int, int, int, uint8_t*:
            ignore: true
          int, int, uint8_t*:
            ignore: true
    inline_code: |
      .def("detect", [](AprilTagDetector *self,
          const nb::ndarray<uint8_t, nb::shape<-1, -1>, nb::c_contig> &img) {

        auto c_result = [&]() {
          nb::gil_scoped_release unlock;
          return new AprilTagDetector::Results(
              self->Detect(static_cast<int>(img.shape(1)), static_cast<int>(img.shape(0)), img.data()));
        }();

        nb::capsule owner(c_result, [](void *p) noexcept {
          delete static_cast<AprilTagDetector::Results *>(p);
        });

        nb::typed<nb::list, AprilTagDetection> l;
        auto len = c_result->size();
        for (size_t i = 0; i < len; i++) {
          l.append(nb::cast((*c_result)[i], nb::rv_policy::reference_internal, owner));
        }
        return l;
      }, nb::arg("image"),
        R"doc(
          Detect tags from an 8-bit grayscale image with shape (height, width)

          :return: list of results
        )doc"
      )
      .def("close", [](AprilTagDetector &self) {
        self = AprilTagDetector();
      }, "Frees all resources associated with this detector")
  frc::AprilTagDetector::Config:
    attributes:
      numThreads:
      quadDecimate:
      quadSigma:
      refineEdges:
      decodeSharpening:
      debug:
    methods:
      operator==:
  frc::AprilTagDetector::QuadThresholdParameters:
    attributes:
      minClusterPixels:
      maxNumMaxima:
      criticalAngle:
      maxLineFitMSE:
      minWhiteBlackDiff:
      deglitch:
    methods:
      operator==:
  frc::AprilTagDetector::Results:
    rename: _Results
    ignored_bases:
    - std::span<const AprilTagDetection* const>
    force_no_trampoline: true
    methods:
      Results:
        overloads:
          '':
            ignore: true
          void*, const private_init&:
            ignore: true
    inline_code: |
      // use the keepalive to keep the array of results around until
      // the user deletes them
      .def("get", [](const AprilTagDetector::Results &self, int i) {
        return self[i];
      }, nb::rv_policy::reference_internal)
